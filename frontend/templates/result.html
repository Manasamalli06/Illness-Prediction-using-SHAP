<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Result - AI HealthGuard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .shap-visualization {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #2c3e50;
        }

        .shap-visualization h3 {
            color: #2c3e50;
            margin-top: 0;
            font-size: 1.3rem;
        }

        .shap-image {
            max-width: 100%;
            height: auto;
            margin: 1rem 0;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .feature-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
            font-size: 0.95rem;
        }

        .feature-table th,
        .feature-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .feature-table th {
            background-color: #2c3e50;
            color: white;
            font-weight: 600;
        }

        .feature-table tr:hover {
            background-color: #f0f0f0;
        }

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            color: #666;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #2c3e50;
            border-bottom-color: #3498db;
            font-weight: 600;
        }

        .tab-button:hover {
            color: #2c3e50;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .simple-interpretation-box {
            margin: 1rem 0;
            padding: 1rem;
            background: linear-gradient(90deg, #f7fbfc, #eef6f8);
            border: 1px solid #d1eef3;
            border-radius: 8px;
        }

        .simple-interpretation-box h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.05rem;
            color: #0b5563;
        }

        .simple-interpretation-box p {
            margin: 0.25rem 0;
            font-size: 1rem;
            color: #13353d;
        }

        .note-box {
            margin-top: 0.8rem;
            padding: 0.9rem;
            background: #fff8e6;
            border-left: 4px solid #f1c40f;
            border-radius: 6px;
            color: #6b4a00;
            font-size: 0.95rem;
        }

        .results-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .shap-box {
            padding: 1.5rem;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #d1eef3;
        }

        .shap-box h3 {
            color: #2c3e50;
            margin-top: 0;
            font-size: 1.2rem;
            margin-bottom: 1rem;
        }

        .shap-box img {
            max-width: 100%;
            height: auto;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .key-drivers-box {
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: linear-gradient(135deg, #fff5f5 0%, #ffe5e5 100%);
            border: 2px solid #ef5350;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(239, 83, 80, 0.15);
        }

        .key-drivers-box h3 {
            color: #c62828;
            margin-top: 0;
            font-size: 1.2rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .drivers-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .driver-item {
            background: white;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #ef5350;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .driver-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
        }

        .driver-value {
            color: #666;
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }

        .driver-impact {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .driver-impact.red {
            background: #ffebee;
            color: #c62828;
            border: 1px solid #ef5350;
        }

        .driver-impact.green {
            background: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #4caf50;
        }

        @media (max-width: 1200px) {
            .results-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>AI HealthGuard</h1>
            <p>Advanced Illness Outcome Prediction System</p>
        </header>

        <main>
            <section class="result-card" style="display: block;">
                <div class="result-header">
                    <h2>Analysis Result</h2>
                    <span class="badge {{ 'badge-high' if risk_level == 'High Risk' else 'badge-low' }}">
                        {{ risk_level }}
                    </span>
                </div>

                <div class="result-metrics">
                    <div class="metric">
                        <span class="label">Confidence Score</span>
                        <span class="value">{{ confidence }}</span>
                    </div>
                </div>

                <div class="simple-interpretation-box">
                    <h3>Quick Summary</h3>
                    <p>{{ simple_interpretation[0] }}</p>
                    <p>{{ simple_interpretation[1] }}</p>
                    <div class="note-box"><strong>Note:</strong> {{ note_message }}</div>
                </div>

                <!-- Key Drivers Box: Main Reasons for Illness -->
                {% if key_drivers %}
                <div class="key-drivers-box">
                    <h3>ðŸ”‘ Key Drivers - Main Reasons for Assessment</h3>
                    <div class="drivers-list">
                        {% for driver in key_drivers %}
                        <div class="driver-item">
                            <div>
                                <div class="driver-name">{{ driver.name }}</div>
                                <div class="driver-value">
                                    {% if driver.name == 'Gender' %}
                                    Value: {{ driver.value }}
                                    {% elif driver.name in ['Age', 'BMI', 'Glucose'] %}
                                    Value: {{ driver.value | string }}
                                    {% else %}
                                    Value: {{ driver.value }}
                                    {% endif %}
                                </div>
                            </div>
                            <span class="driver-impact {% if 'raises' in driver.impact %}red{% else %}green{% endif %}">
                                {{ driver.impact }}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- Clinical Suggestions Box -->
                <div class="key-drivers-box"
                    style="background: linear-gradient(135deg, #f0f7ff 0%, #e0efff 100%); border-color: #2196f3;">
                    <h3>ðŸ’¡ Health Recommendations & Suggestions</h3>
                    <div class="drivers-list">
                        {% for suggestion in suggestions %}
                        <div class="driver-item" style="border-left-color: #2196f3;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <span style="font-size: 1.5rem;">{{ suggestion.icon }}</span>
                                <div>
                                    <div class="driver-name">{{ suggestion.category }}</div>
                                    <div class="driver-value" style="color: #333; font-weight: 500;">{{ suggestion.text
                                        }}</div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <div class="results-grid">
                    <!-- Left Column: Detailed Interpretation -->
                    <div>
                        <div class="explanation-box">
                            <h3>Clinical Interpretation (Detailed)</h3>
                            <p>{{ explanation }}</p>
                        </div>
                    </div>

                    <!-- Right Column: SHAP Visualization -->
                    <div class="shap-box">
                        <h3>Feature Importance (SHAP)</h3>
                        {% if shap_plot %}
                        <img src="data:image/png;base64,{{ shap_plot }}" alt="SHAP Explanation Plot">
                        <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">
                            Red bars indicate features that increase risk prediction; Blue bars indicate features that
                            decrease risk.
                        </p>
                        {% else %}
                        <p style="color: #999; font-style: italic;">SHAP visualization could not be generated.</p>
                        {% endif %}
                    </div>
                </div>

                <!-- Input Features Table -->
                <div class="shap-visualization">
                    <h3>Patient Input Features</h3>
                    <table class="feature-table">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for feature_name, feature_value in feature_pairs %}
                            <tr>
                                <td><strong>{{ feature_name }}</strong></td>
                                <td>
                                    {%- if feature_name == 'Gender' -%}
                                    {{ feature_value }}
                                    {%- else -%}
                                    {{ feature_value | float | round(2) }}
                                    {%- endif -%}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <div class="disclaimer">
                    <small><strong>Note:</strong> This is a decision-support tool using Deep Learning (DNN) and SHAP for
                        explainability. It
                        is not a replacement for professional medical diagnosis.</small>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem; flex-wrap: wrap;">
                    <form method="POST" action="/download_report" style="flex: 1; min-width: 200px;">
                        <input type="hidden" name="risk_level" value="{{ risk_level }}">
                        <input type="hidden" name="confidence" value="{{ confidence }}">
                        <input type="hidden" name="explanation" value="{{ explanation }}">
                        {% for feature_name, feature_value in feature_pairs %}
                        <input type="hidden" name="feature_name_{{ loop.index0 }}" value="{{ feature_name }}">
                        <input type="hidden" name="feature_value_{{ loop.index0 }}"
                            value="{{ feature_value | string }}">
                        {% endfor %}
                        <input type="hidden" name="feature_count" value="{{ feature_pairs | length }}">
                        <button type="submit" class="analyze-btn" style="width: 100%; margin-top: 0;">ðŸ“¥ Download
                            Report</button>
                    </form>
                    <a href="/diagnostics" class="analyze-btn"
                        style="flex: 1; min-width: 200px; text-align: center; display: flex; align-items: center; justify-content: center; text-decoration: none; margin-top: 0;">Analyze
                        New Patient</a>
                </div>
            </section>
        </main>
    </div>

    <script>
        function switchTab(evt, tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));

            // Remove active class from all buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));

            // Show the current tab and mark the button as active
            document.getElementById(tabName).classList.add('active');
            evt.currentTarget.classList.add('active');
        }
    </script>
</body>

</html>